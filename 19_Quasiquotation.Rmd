```{r, echo= FALSE, message=FALSE}
library(rlang)
library(purrr)
```


# Quasiquotation

**Learning objectives:**

- What quasiquotation means
- Why it's important
- Learn some practical uses

## Introduction

- Three pillars of *tidy* evaluation
   1. Quasiquotation
   2. Quosures (chapter 20)
   3. Data masks (Chapter 20)

- Quasiquotation = quotation + unquotation:
   - **Quote.** Capture unevaluated expression ...("defuse")
   - **Unquote.** Except for selected parts which we do want to evaluate! ("inject")
   
- Functions that use these features are said to use Non-standard evaluation (NSE)

- Note: related to Lisp macros, and also exists in other languages with Lisp heritage, e.g. Julia

## Motivation


Simple *concrete* example:

`Cement` is a function that works like `paste` but doesn't need need quotes:

```{r}
cement <- function(...) {
  args <- ensyms(...)
  paste(purrr::map(args, as_string), collapse = " ")
}

cement(Good, morning, Hadley)
```

What if we wanted to use variables ?   This is where 'unquoting' comes in!

```{r}
name = "Bob"
cement(Good, afternoon, !!name)
```


 
## Nonstandard evaluation {-}

* Functions like `dplyr::filter` use nonstandard evaluation and quote some of their arguments to help make code more *tidy*.

```{r}
#| eval: FALSE
# `cyl` is written as a bare name--a symbol defined in the global environment
# but `cyl` only exists in the data frame "environment"
# so, `{dplyr}` quotes the argument
dplyr::filter(mtcars, cyl == 4)
```
 
* You often can detect this if the argument wouldn't work in isolation, for example:

```{r, eval = FALSE}
library(MASS) # this is fine
MASS 
#> Error: object MASS not found
```

and 

```{r, eval = FALSE}
cyl 
#> Error: object 'cyl' not found
```


## Quote

- Expression

```{r}
# for interactive use
rlang::expr(x+y)

# enexpr works on function arguments (looks at internal promise object)  
f2 <- function(x) rlang::enexpr(x)
f2(a + b + c)
```
- To capture multiple arguments, use `enexprs()`

```{r}
f <- function(...) enexprs(...)
f(x=1, y= 10 *z)
```


- For symbols, there is `ensym` and `ensyms` which check that the argument is a symbol or string.

## Base R method {-}

* Base R methods do not support unquoting.

* Base R equivalent of `expr` is `quote`  

* Base R equivalent of `enexpr` is `substitute` (note that `enexpr` uses `substitute`!)

```{r, eval = FALSE}
enexpr
#>function (arg) 
#>{
#>    .Call(ffi_enexpr, substitute(arg), parent.frame())
#>}
```


* `bquote()` provides a limited form of quasiquotation, see section 19.5

* `~`, the formula, is a quoting function, discussed in Section 20.3.4

## Unquote

- Unquoting allows you to 'splice' together ASTs 

- One argument
```{r}
# quote `-1` as `x`
x <- rlang::expr(-1)
# unquote `x` to substitute its unquoted value
# use bang-bang operator
res = rlang::expr(f(!!x, y))
print(res)
lobstr::ast(!!res)
```


- Multiple arguments, use `!!!`

```{r}
xs <- rlang::exprs(1, a, -b)
# unquote multiple arguments
# use bang-bang-bang operator
res=expr(f(!!!xs, y))
res
```
```{r}
lobstr::ast(!!res)
```
 


## Quote and unquote

- **Single argument.** Embrace the simplicity of the embrace operator `{{`
```{r}
#| label: embrace
#| eval: FALSE

# The hard way
my_hard_summarize <- function(data, var) {
  # defuse (aka quote)
  var <- rlang::enquo(var)
  
  # inject (aka unquote)
  dplyr::summarize(data, mean = mean(!!var, na.rm = TRUE))
    
}

# The easy way
my_easy_summarize <- function(data, var) {

  # in one move, quote and unquote `var`
  dplyr::summarize(data, mean = mean({{var}}, na.rm = TRUE))
    
}

```


- **Multiple arguments.** Just pass the (dynamic) dots when you can. Otherwise, quote (e.g., `rlang::enquos`) and splice (`!!!`).


```{r}
#| label: dots

# The easy way for easy cases of simple "forwarding"
my_group_by <- function(.data, ...) {
  .data %>% dplyr::group_by(...)
}

mtcars %>% my_group_by(cyl = cyl * 100, am)

# The harder way remains the solution for non-forwarding use cases
# There is no plural version of the embrace operator `{{`
```



## Meeting Videos

### Cohort 1

`r knitr::include_url("https://www.youtube.com/embed/tbByqsRRvdE")`

### Cohort 2

`r knitr::include_url("https://www.youtube.com/embed/IXE21pR8EJ0")`

### Cohort 3

`r knitr::include_url("https://www.youtube.com/embed/gxSpz6IePLg")`

### Cohort 4

`r knitr::include_url("https://www.youtube.com/embed/aniKrZrr4aU")`

### Cohort 5

`r knitr::include_url("https://www.youtube.com/embed/klcpEb5ZBSM")`

### Cohort 6

`r knitr::include_url("https://www.youtube.com/embed/OBodjc80y-E")`

<details>
<summary> Meeting chat log </summary>

```
01:02:07	Trevin:	Yeah, that was a great workshop
01:02:18	Trevin:	Glad they posted the resources online
01:06:39	Trevin:	Thank you!
```
</details>

### Cohort 7

`r knitr::include_url("https://www.youtube.com/embed/URL")`

<details>

<summary>Meeting chat log</summary>
```
LOG
```
</details>
